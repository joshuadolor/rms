# Dev: docker compose up. Then open http://localhost (via nginx) or http://localhost:8080 (Vite). Mailhog: :8025
services:
  nginx:   # Single origin: / → frontend, /api → API. *.rms.local → Laravel (Blade). Use http://localhost or http://test.rms.local
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      # Mount config so edits apply without rebuild. Restart or reload nginx after editing: docker compose restart nginx
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api
      - frontend

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      # Mount host API code so route/code changes apply without rebuilding (run composer install on host if needed)
      - ./api:/app
      # Persist DB; overrides /app/storage/db from the mount above
      - api_database:/app/storage/db
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_URL=http://rms.local
      - FRONTEND_URL=http://rms.local
      - RESTAURANT_DOMAIN=rms.local
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/app/storage/db/database.sqlite
      # Mailhog: API sends mail to mailhog:1025 (SMTP). View at http://localhost:8025
      - MAIL_MAILER=smtp
      - MAIL_HOST=mailhog
      - MAIL_PORT=1025
      - MAIL_USERNAME=null
      - MAIL_PASSWORD=null
      - MAIL_ENCRYPTION=null
      - MAIL_FROM_ADDRESS=noreply@rms.local
      - MAIL_FROM_NAME="${APP_NAME:-RMS}"
    depends_on:
      - mailhog

  frontend:
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "8080:8080"
    command: sh -c "npm install && npm run dev"
    environment:
      - NODE_ENV=development
      # With nginx: open http://localhost (port 80); frontend uses relative /api. Without nginx: open http://localhost:8080 and Vite proxies /api.
      - VITE_PROXY_TARGET=http://api:3000
      - VITE_API_URL=
      - VITE_APP_PUBLIC_DOMAIN=rms.local
    depends_on:
      - api

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI

volumes:
  frontend_node_modules:
  api_database:
