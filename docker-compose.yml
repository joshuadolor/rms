# Dev: docker compose up. Then open http://localhost (via nginx) or http://localhost:8080 (Vite). Mailhog: :8025. phpMyAdmin: :8081 (local only).
# Env: set variables in .env (project root, next to this file). Copy from .env.example.
# First time (or after adding migrations): docker compose exec api php artisan migrate
services:
  nginx:   # Single origin: / → frontend, /api → API. *.rms.local → Laravel (Blade). Use http://localhost or http://test.rms.local
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      # Mount config so edits apply without rebuild. Restart or reload nginx after editing: docker compose restart nginx
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api
      - frontend

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"   # optional: for local DB tools (e.g. TablePlus, mysql CLI)
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-rms}
      MYSQL_USER: ${MYSQL_USER:-rms}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-rms_secret}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_secret}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p\"$$MYSQL_ROOT_PASSWORD\" || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      # Mount host API code so route/code changes apply without rebuilding (run composer install on host if needed)
      - ./api:/app
      # Single source: Laravel reads this file (project root .env). Create from .env.example; run key:generate once.
      - ./.env:/app/.env
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - APP_URL=${APP_URL:-http://rms.local}
      - FRONTEND_URL=${FRONTEND_URL:-http://rms.local}
      - RESTAURANT_DOMAIN=${RESTAURANT_DOMAIN:-rms.local}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-rms}
      - DB_USERNAME=${DB_USERNAME:-rms}
      - DB_PASSWORD=${DB_PASSWORD:-rms_secret}
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST:-mailhog}
      - MAIL_PORT=${MAIL_PORT:-1025}
      - MAIL_USERNAME=${MAIL_USERNAME:-null}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-null}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-null}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-noreply@rms.local}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-RMS}
      # Machine translation: set TRANSLATION_DRIVER=libre and LIBRE_TRANSLATE_URL when using libretranslate service
      - TRANSLATION_DRIVER=${TRANSLATION_DRIVER:-libre}
      - LIBRE_TRANSLATE_URL=${LIBRE_TRANSLATE_URL:-http://libretranslate:5000}
      - LIBRE_TRANSLATE_API_KEY=${LIBRE_TRANSLATE_API_KEY:-}
    depends_on:
      mysql:
        condition: service_healthy
      mailhog:
        condition: service_started
      libretranslate:
        condition: service_started

  frontend:
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "8080:8080"
    command: sh -c "npm install && npm run dev"
    environment:
      - NODE_ENV=development
      - VITE_PROXY_TARGET=${VITE_PROXY_TARGET:-http://api:3000}
      - VITE_API_URL=${VITE_API_URL:-}
      - VITE_APP_PUBLIC_DOMAIN=${VITE_APP_PUBLIC_DOMAIN:-rms.local}
    depends_on:
      - api

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI

  # Machine translation (LibreTranslate). API uses it when TRANSLATION_DRIVER=libre and LIBRE_TRANSLATE_URL set.
  # Host port 5001 to avoid conflict with other services on 5000; override with LIBRE_TRANSLATE_PORT in .env if needed.
  libretranslate:
    image: libretranslate/libretranslate:latest
    ports:
      - "${LIBRE_TRANSLATE_PORT:-5001}:5000"
    environment:
      # Optional: disable suggested languages to reduce memory; or leave default
      - LT_LOAD_ONLY=en,es,fr,de,nl,ru
    # First start can be slow while models load; API returns 503 until LibreTranslate is ready

  # Local only: DB admin UI. Login with root/root_secret or rms/rms_secret. Do not enable in production.
  phpmyadmin:
    image: phpmyadmin:latest
    ports:
      - "8081:80"
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - UPLOAD_LIMIT=64M
    depends_on:
      mysql:
        condition: service_healthy

volumes:
  frontend_node_modules:
  mysql_data:
